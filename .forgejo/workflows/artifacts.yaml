# SPDX-FileCopyrightText: 2024 Mathieu Fenniak <mathieu@fenniak.net>
#
# SPDX-License-Identifier: GPL-3.0-or-later

name: Release Artifacts

on:
  push:
    tags:
      - 'v*'

jobs:
  oci-container:
    runs-on: debian-ci-latest
    container:
      options: --volume nix-forgejo-cache-public:/nix
    env:
      DOCKER_HOST: "tcp://forgejo-act-runner-docker-in-docker:2375"
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - uses: https://github.com/cachix/install-nix-action@c134e4c9e34bac6cab09cf239815f9339aaaf84e # v31
      # install-nix-action by default uses {{ github.token }} and configures it as a github token; makes sense, but
      # we're running as a Forgejo action so Forgejo puts its own token in {{ github.token }} which GitHub can't
      # understand. So we replace github.com in the access-token field of the nix.conf file.
      - run: sed -i 's/github.com/codeberg.org/' /etc/nix/nix.conf
      - name: nix build docker
        run: nix build .#docker
      - name: load docker container
        run: gunzip < result | docker load
      - name: docker login
        run: echo "${{ secrets.TESTTRIM_PACKAGE_REGISTRY_PAT }}" | docker login codeberg.org -u mfenniak --password-stdin
      - name: push versioned docker container
        # GITHUB_REF_NAME should be the tag name (eg. v0.2.1), but the container is built without the leading v...
        run: docker push codeberg.org/testtrim/server:${GITHUB_REF_NAME#v}
      - name: docker tag and push latest
        run: docker tag codeberg.org/testtrim/server:${GITHUB_REF_NAME#v} codeberg.org/testtrim/server:latest && docker push codeberg.org/testtrim/server:latest
